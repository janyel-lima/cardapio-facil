<div x-show="showProductModal && selectedProduct"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     class="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showProductModal=false"></div>
    <div x-show="showProductModal && selectedProduct"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="translate-y-full sm:translate-y-0 sm:scale-95 opacity-0"
         x-transition:enter-end="translate-y-0 sm:scale-100 opacity-100"
         class="relative bg-surface-card w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden shadow-2xl max-h-[92vh] flex flex-col">
        <template x-if="selectedProduct">
            <div class="flex flex-col overflow-hidden">
                <div class="relative h-48 flex-shrink-0">
                    <img :src="selectedProduct.image" :alt="selectedProduct.name" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <button @click="showProductModal=false" class="absolute top-4 right-4 bg-black/40 text-white rounded-full w-8 h-8 flex items-center justify-center">‚úï</button>
                    <div x-show="selectedProduct.promoPrice" class="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-2.5 py-1 rounded-xl">üî• PROMO√á√ÉO</div>
                    <div class="absolute bottom-4 left-4">
                        <h2 class="text-xl font-display font-bold text-white" x-text="selectedProduct.name"></h2>
                    </div>
                </div>

                <div class="p-5 overflow-y-auto flex-1 space-y-4">
                    <p class="text-sm text-text-muted leading-relaxed" x-text="selectedProduct.desc"></p>

                    <div class="flex items-center justify-between">
                        <div>
                            <div x-show="selectedProduct.promoPrice" class="flex items-baseline gap-2">
                                <span class="text-sm text-text-muted line-through" x-text="formatMoney(selectedProduct.price)"></span>
                                <span class="text-2xl font-display font-bold text-accent" x-text="formatMoney(selectedProduct.promoPrice)"></span>
                            </div>
                            <span x-show="!selectedProduct.promoPrice" class="text-2xl font-display font-bold text-accent" x-text="formatMoney(selectedProduct.price)"></span>
                        </div>
                        <div class="flex items-center gap-3 bg-surface-muted rounded-xl p-1">
                            <button @click="if(modalQty>1) modalQty--" class="w-8 h-8 rounded-lg bg-surface-card flex items-center justify-center font-bold text-text-primary shadow-sm">‚àí</button>
                            <span x-text="modalQty" class="font-display font-bold text-text-primary w-6 text-center"></span>
                            <button @click="modalQty++" class="w-8 h-8 rounded-xl flex items-center justify-center text-white font-bold shadow-sm" :style="'background:var(--accent)'">+</button>
                        </div>
                    </div>

                    <template x-if="selectedProduct.complements && selectedProduct.complements.length > 0">
                        <div class="space-y-4">
                            <template x-for="group in selectedProduct.complements" :key="group.id">
                                <div class="complement-group rounded-2xl border border-border overflow-hidden">
                                    <div class="flex items-center justify-between px-4 py-3 bg-surface-muted border-b border-border">
                                        <div>
                                            <h4 class="font-display font-bold text-text-primary text-sm" x-text="group.name"></h4>
                                            <p class="text-xs text-text-muted mt-0.5">
                                                <span x-show="group.required" class="text-accent font-medium">Obrigat√≥rio</span>
                                                <span x-show="!group.required" class="text-text-muted">Opcional</span>
                                                <span x-show="group.type==='multiple'"> ‚Ä¢ At√© <span x-text="group.max"></span> op√ß√£o(√µes)</span>
                                                <span x-show="group.type==='single'"> ‚Ä¢ Escolha 1</span>
                                            </p>
                                        </div>
                                        <span class="text-xs font-bold rounded-full px-2 py-1 transition-colors"
                                              :class="(modalSelectedComplements[group.id]||[]).length > 0 ? 'bg-accent/10 text-accent' : 'bg-surface-card text-text-muted'">
                                            <span x-text="(modalSelectedComplements[group.id]||[]).length"></span>/<span x-text="group.type==='single'?1:group.max"></span>
                                        </span>
                                    </div>
                                    <div class="divide-y divide-border">
                                        <template x-for="option in group.options" :key="option.id">
                                            <button @click="toggleComplement(group, option)"
                                                    class="complement-option w-full flex items-center gap-3 px-4 py-3 hover:bg-surface-muted transition-colors text-left"
                                                    :class="isComplementSelected(group.id, option.id) ? 'bg-accent/5 border-l-2 border-accent' : ''">
                                                <div class="w-5 h-5 rounded flex items-center justify-center flex-shrink-0 transition-all border-2"
                                                     :class="isComplementSelected(group.id, option.id)
                                                       ? 'border-transparent text-white'
                                                       : 'border-border bg-surface-card'"
                                                     :style="isComplementSelected(group.id, option.id) ? 'background:var(--accent)' : ''"
                                                     :style="group.type==='single' ? 'border-radius:50%' : 'border-radius:5px'"
                                                     style="">
                                                    <svg x-show="isComplementSelected(group.id, option.id)" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                                </div>
                                                <span class="flex-1 text-sm text-text-primary font-medium" x-text="option.name"></span>
                                                <span class="text-sm font-bold flex-shrink-0"
                                                      :class="option.price > 0 ? 'text-accent' : 'text-text-muted'">
                                                    <span x-show="option.price > 0">+<span x-text="formatMoney(option.price)"></span></span>
                                                    <span x-show="option.price === 0" class="text-text-muted text-xs">Gr√°tis</span>
                                                </span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <div>
                        <label class="form-label mb-2">Observa√ß√µes (opcional)</label>
                        <textarea x-model="modalNote" placeholder="Ex: sem cebola, ponto bem passado, tirar o molho‚Ä¶" rows="2"
                                  class="w-full text-sm bg-surface-muted text-text-primary placeholder-text-muted rounded-xl p-3 outline-none focus:ring-2 ring-accent resize-none transition-all"></textarea>
                    </div>

                    <div x-show="modalComplementsTotal > 0" class="complement-summary rounded-xl p-3 flex items-center justify-between text-sm">
                        <span class="text-text-muted">Adicionais selecionados</span>
                        <span class="font-bold text-accent">+<span x-text="formatMoney(modalComplementsTotal)"></span></span>
                    </div>

                    <button @click="confirmAddToCart()"
                            :disabled="!selectedProduct.available"
                            class="w-full py-3.5 rounded-2xl text-white font-display font-bold text-base shadow-lg transition-all active:scale-[0.98] disabled:opacity-50"
                            :style="'background:var(--accent)'">
                        <span x-show="selectedProduct.available">
                            Adicionar ‚Ä¢ <span x-text="formatMoney(((selectedProduct.promoPrice||selectedProduct.price) + modalComplementsTotal) * modalQty)"></span>
                        </span>
                        <span x-show="!selectedProduct.available">Item Indispon√≠vel</span>
                    </button>
                </div>
            </div>
        </template>
    </div>
</div>